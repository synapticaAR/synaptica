<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat con IA ‚Äì Synaptica</title>
  <link rel="icon" href="favicon.png">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav>
    <a href="index.html">Inicio</a>
    <a href="ayuda.html">Ayuda</a>
    <a href="chat.html" aria-current="page">IA Especializada</a>
    <a href="relajacion.html">Relajaci√≥n</a>
    <a href="psicologo.html">Psic√≥logo</a>
  </nav>

  <header>
    <h1>IA Especializada</h1>
    <p>Convers√° con Synaptica y sent√≠ el apoyo real</p>
  </header>

  <section class="chat-section" id="chat">
    <div id="chatBox" class="chat-box" aria-live="polite"></div>

    <div class="chat-input">
      <textarea id="userInput" rows="2" placeholder="Escrib√≠ c√≥mo te sent√≠s‚Ä¶"></textarea>
      <button id="send-btn">Enviar</button>
      <button id="vozToggle">üîä Voz ON</button>
      <button id="mic-btn">üé§</button>
    </div>
  </section>

  <!-- SCRIPT PRINCIPAL DEL CHAT -->
  <script>
    const memory = [];
    const chatBox = document.getElementById("chatBox");
    const sendBtn = document.getElementById("send-btn");
    const vozToggle = document.getElementById("vozToggle");
    let vozActiva = true;

    const rutas = [
      { re: /psic[o√≥]log/i, href: "psicologo.html" },
      { re: /ayuda|urgencia|contenci[o√≥]n|hablar con alguien/i, href: "ayuda.html" },
      { re: /relaja|respira|medita|ansiedad/i, href: "relajacion.html" },
      { re: /chat|ia|convers/i, href: "chat.html" }
    ];

    const saludos = [
      "Hola, soy Synaptica üå±\nEstoy ac√° para escucharte.",
      "¬°Bienvenido! Soy Synaptica. Contame c√≥mo te sent√≠s.",
      "Hola üëã Soy tu acompa√±ante emocional. ¬øEn qu√© puedo ayudarte hoy?"
    ];

    pushMessage("ia", saludos[Math.floor(Math.random() * saludos.length)]);

    function pushMessage(role, text) {
      const msg = document.createElement("div");
      msg.className = "message " + (role === "user" ? "user" : "ia");
      msg.textContent = text;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
      if (role === "ia" && vozActiva) hablar(text);
      memory.push({ role: role === "user" ? "user" : "assistant", content: text });
    }

    async function sendMessage() {
      const input = document.getElementById("userInput");
      const message = input.value.trim();
      if (!message) return;

      pushMessage("user", message);
      input.value = "";

      for (const r of rutas) {
        if (r.re.test(message)) {
          pushMessage("ia", "Entiendo c√≥mo te sent√≠s. Te acompa√±o...");
          setTimeout(() => location.href = r.href, 1000);
          return;
        }
      }

      const typing = document.createElement("div");
      typing.className = "message ia";
      typing.textContent = "Synaptica est√° escribiendo‚Ä¶";
      chatBox.appendChild(typing);
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        const res = await fetch("https://eae9efbf-3f34-41bb-b03b-4ad9dbeedd61-00-23tds4nuay46d.picard.replit.dev/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: memory })
        });

        const data = await res.json();
        typing.remove();
        let textoIA = data.reply || "Sin respuesta del servidor.";

        if (/^(sou|estou|psic[o√≥]logo|psic[o√≥]loga)/i.test(textoIA) && /portugu/i.test(textoIA)) {
          textoIA = "¬øQuer√©s hablar con un psic√≥logo? Podemos ayudarte.";
        }

        if (/mal|triste|ansiedad|angustia|depre|solo/i.test(message)) {
          textoIA = "Entiendo c√≥mo te sent√≠s. Podemos ayudarte.";
          setTimeout(() => location.href = "psicologo.html", 3000);
        }

        pushMessage("ia", textoIA);

      } catch (err) {
        typing.remove();
        pushMessage("ia", "‚ö†Ô∏è Error al conectar con el servidor.");
      }
    }

    function hablar(texto) {
      if (!vozActiva) return;
      const voz = new SpeechSynthesisUtterance(texto);
      voz.lang = "es-AR";
      speechSynthesis.cancel(); // Evita superposiciones
      speechSynthesis.speak(voz);
    }

    function toggleVoz() {
      vozActiva = !vozActiva;
      vozToggle.textContent = vozActiva ? "üîä Voz ON" : "üîá Voz OFF";
      if (!vozActiva) speechSynthesis.cancel();
    }

    sendBtn.addEventListener("click", sendMessage);
  </script>

  <!-- SCRIPT EXTERNO PARA MICR√ìFONO -->
  <script src="script.js"></script>
</body>
</html>
